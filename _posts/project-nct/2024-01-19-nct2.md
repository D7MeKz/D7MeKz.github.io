---
title: NCT 인프라 개선기 - 2. 서버 진단 그리고 도커 레지스트리
author: cotes
date: 2024-01-19
categories: [Proejct, NCT]
tags: [Project, Infra]
---

# 들어가며

NCT 프로젝트에서는 작은 PC를 자체 구축하여 사용하고 있다. RAM 8GB, 256GB의 저장 공간을 가지고 있다. 사용하는 컨테이너 수가 적어 리소스를 많이 쓰지 않지만, 관리는 필수라고 생각했다. 그래서 서버를 진단해보고자 한다.

## 부족한 저장 공간 그리고 도커 이미지

저장 공간을 확인했는데, 생각보다 용량이 적게 남았다. 남은 용량도 충분하다. 그러나 불필요한 무언가가 지속적으로 저장되었다는 것은 **앞으로도 계속 저장 공간을 차지할 것이라는 의미**이기도 한다.
![](/assets/img/post/2024-01-19/df.png)

문제의 원인은 간단했다. 불필요한 도커 이미지가 쌓였던 것. 서버에 전반적인 도커 이미지 정리가 필요해 보였다.

![file](/assets/img/post/2024-01-19/docker_df.png)

## 정리하면 끝?

**“도커 이미지를 관리해주는 것이 있을까?”** 이게 나의 첫 물음이었다. 그리고 CI/CD 파이프라인이 나에게 답을 주었다. 바로 Image Registry이다.

### CI/CD 파이프라인

배포에서 파이프라인이란 소스 코드의 관리부터 실제 서비스로의 배포 과정을 연결하는 구조를 뜻한다. 일반적으로 개발자가 코드를 수정하면 수동으로 push&pull를 해야했었다. 이러한 반복적인 프로세스를 자동화하여 시간을 절약하기 위해 CI/CD 파이프라인을 사용하게 되는 것이다.

> CI / CD 파이프 라인 목표는빌드, 테스트 및 제공을 수동 처리보다 더 빠르고 자동화되고 안정적으로 만드는 것이다.
>
> 출처: [https://inpa.tistory.com/entry/👩‍💻-CI-CD-파이프-라인-이란](https://inpa.tistory.com/entry/%F0%9F%91%A9%E2%80%8D%F0%9F%92%BB-CI-CD-%ED%8C%8C%EC%9D%B4%ED%94%84-%EB%9D%BC%EC%9D%B8-%EC%9D%B4%EB%9E%80) > [Inpa Dev 👨‍💻:티스토리]
{: .prompt-info }

여기서 우리가 봐야하는 것은 Build Stage 단계에서의 빌드 결과물 생성이다. 도커에서 빌드의 결과물은 도커 이미지가 된다. 즉 Deploy 단계에서는 Build 단계에서 생성한 이미지를 가지고 실제 서비스에 반영하는 것이다.

![](/assets/img/post/2024-01-19/CI:CD%20pipeline.png)
_출처 - https://velog.io/@edith_0318/CICD-파이프라인_

CI/CD 파이프라인의 구성 요소는 총 5가지이다.

- 빌드 (소프트웨어 컴파일)
- 테스트 (호환성 및 오류 검사)
- 릴리스 (버전 제어 저장소의 애플리케이션 업데이트)
- 배포 (개발에서 프로덕션 환경으로의 변환)
- 규정 준수 및 유효성 검사

릴리즈 단계에서 **버전 제어 저장소의 애플리케이션 업데이트**라고 적혀있다. 즉, 저장소를 통해 내가 원하고자 하는 개발 및 운영 환경 배포는 버전 제어 저장소에 있는 도커 이미지를 배포하는 것과 같다고 볼 수 있다.

## 도커 레지스트리

대부분의 클라우드 서비스에는 포함이 되어 있으며, docker 또한 레지스트리를 제공한다.

- public으로 인터넷상에서 운영되는 Docker Hub 사이트
- 기업망 내부에서 사용하는 경우
- 자신의 로컬서버에 설치해 사용할 수 있는 Private Local Registry

docker hub를 사용하는 것도 좋지만, 별도의 로그인이 필요하고 이미지가 공개돼 보안상에 문제가 될 수 있다는 점에서 docker registry를 선택하게 되었다.

> Q. 왜 도커 레지스트리를 사용하지?
>
> A. Docker Registry를 사용하는 이유는 첫번째로 생성되는 이미지들의 위치를 통제할 수 있고, CI(Continuous Integration), CD(Continuous deployment)를 지원하는 Tool들과 파이프라인을 구성해 운영의 자동화를 가능하게 해줍니다.
>
> 출처 - https://ppp0183.tistory.com/78
{: .prompt-tip }

## 아키텍쳐 반영

기존에는 젠킨스에서 바로 production 환경에 배포했었다. 앞으로 많은 버전의 서비스가 나올 것을 대비해서 도커 레지스트리를 구축해 도커 이미지를 관리하고, 파이프라인을 제대로 구현해보려고 한다.

![](/assets/img/post/2024-01-19/20240119_nct_arch_v0.2.png)

## 참고

- [CI-CD 파이프라인이란](https://inpa.tistory.com/entry/👩‍💻-CI-CD-파이프-라인-이란)
- [CI/CD 파이프라인](https://velog.io/@edith_0318/CICD-파이프라인)
- [[클라우드] 5. Docker Registry](https://ppp0183.tistory.com/78)
